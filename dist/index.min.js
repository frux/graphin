'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _fetchPonyfill2=require('fetch-ponyfill');var _fetchPonyfill3=_interopRequireDefault(_fetchPonyfill2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var _fetchPonyfill=(0,_fetchPonyfill3.default)(),fetch=_fetchPonyfill.fetch;var GraphinCache=function(){function GraphinCache(data,ttl){_classCallCheck(this,GraphinCache);this._ttl=ttl||0;this.update(data);}_createClass(GraphinCache,[{key:'update',value:function update(newData){this._data=newData;this._timestamp=Number(new Date());return this;}},{key:'getData',value:function getData(){return this._data;}},{key:'isOutdated',value:function isOutdated(){return Number(new Date())-this._timestamp>this._ttl;}}]);return GraphinCache;}();function normalizeIndent(text){var indents=/\n(\s*)\S?.*$/.exec(text);if(indents){var _ret=function(){var reduceSize=indents&&indents[indents.length-1].length;return{v:text.split('\n').map(function(row){return row.replace(new RegExp('^\\s{'+reduceSize+'}'),'');}).join('\n')};}();if((typeof _ret==='undefined'?'undefined':_typeof(_ret))==="object")return _ret.v;}return text;}function _startProfiling(){var startTime=Number(new Date());return function(){return Number(new Date())-startTime;};}var GraphinError=function(_Error){_inherits(GraphinError,_Error);function GraphinError(apiErrors,url){_classCallCheck(this,GraphinError);var query=normalizeIndent(decodeURIComponent(url.replace(/^.+\?query=/,'')));var errors=apiErrors.reduce(function(errors,error){var message=error.message;var stack=message+'\n'+query+'\n'+JSON.stringify(error.locations);errors.message+='\n\n'+message;errors.stack+='\n\n'+stack;errors.originalErrors.push(new Error(message));return errors;},{originalErrors:[],message:'GraphQl error:',stack:'GraphQl error:'});var _this=_possibleConstructorReturn(this,(GraphinError.__proto__||Object.getPrototypeOf(GraphinError)).call(this,errors.message));_this.stack=errors.stack;_this.originalErrors=errors.errors;_this.url=errors.url;return _this;}return GraphinError;}(Error);var Graphin=function(){function Graphin(endpoint){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var fetcher=arguments.length>2&&arguments[2]!==undefined?arguments[2]:fetch;_classCallCheck(this,Graphin);if(typeof endpoint!=='string'){throw new Error('The first argument must be a string containing GraphQL endpoint URL');}this.getQueryURL=function(query){var inlineQuery=encodeURIComponent(query);return endpoint+'?query='+inlineQuery;};this._options={cache:options.cache||false,fetch:options.fetch||{},verbose:options.verbose||false};this._fetcher=fetcher;this._cacheStorage={};}_createClass(Graphin,[{key:'_fetch',value:function _fetch(url){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(options.headers===undefined){options.headers={};}if(options.headers.Accept===undefined&&options.headers.accept===undefined){options.headers.Accept='application/json';}return this._fetcher(url,options).then(function(response){return response.json().then(function(data){if(response.ok&&!data.errors){return data.data;}if(data.errors){throw new GraphinError(data.errors,url);}else{throw new Error('Request error: '+response.statusText);}});});}},{key:'query',value:function query(_query){var _this2=this;var requestOptions=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var queryURL=this.getQueryURL(_query);var options=Object.assign({},this._options,requestOptions);var fetchOptions=Object.assign({},this._options.fetch,requestOptions.fetch);var _stopProfiling=_startProfiling();fetchOptions.method=fetchOptions.method||'POST';fetchOptions.credential=fetchOptions.credential||'omit';if(options.cache&&this._cacheStorage[queryURL]&&!this._cacheStorage[queryURL].isOutdated()){return Promise.resolve(this._cacheStorage[queryURL].getData());}if(typeof _query!=='string'){throw new Error('Query must be a string');}return this._fetch(queryURL,fetchOptions).then(function(data){if(options.verbose){console.log('Graphin '+_stopProfiling()+'ms \u2714\uFE0E\n'+normalizeIndent(_query)+'\n'+queryURL);}return data;}).then(function(data){if(options.cache){if(_this2._cacheStorage[queryURL]){_this2._cacheStorage[queryURL].update(data);}else{_this2._cacheStorage[queryURL]=new GraphinCache(data,options.cache);}}return data;}).catch(function(err){if(options.verbose){console.log('Graphin '+_stopProfiling()+'ms \u2718\n'+normalizeIndent(_query)+'\n'+queryURL);}throw err;});}}]);return Graphin;}();exports.default=Graphin;
